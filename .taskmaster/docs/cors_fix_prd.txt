# PRD: Docker ëª¨ë…¸ë ˆí¬ CORS ì •ì±… ìœ„ë°˜ ìë™ í•´ê²°

**ë¬¸ì„œ ë²„ì „**: 1.0  
**ì‘ì„±ì¼**: 2026-01-15  
**ìš°ì„ ìˆœìœ„**: ğŸ”´ Critical  
**ë‹´ë‹¹ì**: AI Agent (ìë™ ì‹¤í–‰)

---

## 1. ë¬¸ì œ ì •ì˜ (Problem Statement)

### 1.1 í˜„ì¬ ìƒí™©

ì‚¬ìš©ìì˜ íšŒì‚¬ ì‚¬ë‚´ ë„¤íŠ¸ì›Œí¬ì—ì„œ Dockerë¡œ êµ¬ë™ë˜ëŠ” ëª¨ë…¸ë ˆí¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë‹¤ì¤‘ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì—ì„œ ì ‘ê·¼í•  ë•Œ **CORS(Cross-Origin Resource Sharing) ì •ì±… ìœ„ë°˜** ì—ëŸ¬ ë°œìƒ.

### 1.2 ì—ëŸ¬ ë©”ì‹œì§€

```
Access to fetch at 'http://172.30.1.42:4000/api/auth/login'
from origin 'http://100.69.75.47:3000'
has been blocked by CORS policy:
Response to preflight request doesn't pass access control check:
The 'Access-Control-Allow-Origin' header has a value 'http://172.30.1.42:3000'
that is not equal to the supplied origin.
```

### 1.3 ê·¼ë³¸ ì›ì¸

| í•­ëª©                | ìƒì„¸                                                                 |
| ------------------- | -------------------------------------------------------------------- |
| **í´ë¼ì´ì–¸íŠ¸ ì¶œì²˜** | `http://100.69.75.47:3000` (Tailscale IP)                            |
| **ë°±ì—”ë“œ API**      | `http://172.30.1.42:4000/api/auth/login` (ìœ ì„  IP)                   |
| **ì„œë²„ ì„¤ì •**       | `Access-Control-Allow-Origin: http://172.30.1.42:3000` (ìœ ì„ ë§Œ í—ˆìš©) |
| **ê²°ê³¼**            | Origin ë¶ˆì¼ì¹˜ë¡œ ë¸Œë¼ìš°ì €ê°€ API ìš”ì²­ ì°¨ë‹¨                             |

### 1.4 ì˜í–¥ ë²”ìœ„

- âŒ Tailscale VPN ë„¤íŠ¸ì›Œí¬ì—ì„œ ì ‘ê·¼ ë¶ˆê°€
- âŒ ë‹¤ë¥¸ ì¸µ ë¬´ì„  ë„¤íŠ¸ì›Œí¬ì—ì„œ ì ‘ê·¼ ë¶ˆê°€ (221.147.112.147)
- âŒ ë‹¤ë¥¸ ê±´ë¬¼ì—ì„œì˜ ì ‘ê·¼ ë¶ˆê°€
- âœ… ìœ ì„  LAN(172.30.1.x)ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥

### 1.5 ë¹„ì¦ˆë‹ˆìŠ¤ ì„íŒ©íŠ¸

- **ê°œë°œ ìƒì‚°ì„± ì €í•˜**: ê°œë°œìë“¤ì´ ëª¨ë°”ì¼, ë¬´ì„  í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ ë¶ˆê°€
- **ì›ê²© í˜‘ì—… ì œì•½**: ë‹¤ë¥¸ ì¸µ/ê±´ë¬¼ íŒ€ì›ë“¤ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ì ‘ê·¼ ë¶ˆê°€
- **ë°°í¬ ê²€ì¦ ì œì•½**: ì „ì²´ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì—ì„œì˜ í†µí•© í…ŒìŠ¤íŠ¸ ë¶ˆê°€

---

## 2. ëª©í‘œ (Objectives)

### 2.1 Primary Goal

**ëª¨ë“  ì‚¬ë‚´ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì—ì„œ ì¸ì¦ ì—†ì´ ë°±ì—”ë“œ APIì— ì ‘ê·¼ ê°€ëŠ¥**í•˜ë„ë¡ CORS ì •ì±… ìë™ ìˆ˜ì •

### 2.2 Success Criteria

| ê¸°ì¤€                   | ìƒì„¸                                 | ê²€ì¦ ë°©ë²•                         |
| ---------------------- | ------------------------------------ | --------------------------------- |
| **ìœ ì„  ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼** | 172.30.1.40:3000ì—ì„œ ë¡œê·¸ì¸ ì„±ê³µ     | ë¸Œë¼ìš°ì € í…ŒìŠ¤íŠ¸                   |
| **Tailscale ì ‘ê·¼**     | 100.69.75.47:3000ì—ì„œ ë¡œê·¸ì¸ ì„±ê³µ    | Tailscale í´ë¼ì´ì–¸íŠ¸ í…ŒìŠ¤íŠ¸       |
| **ë¬´ì„  ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼** | 221.147.112.147:3000ì—ì„œ ë¡œê·¸ì¸ ì„±ê³µ | WiFi í´ë¼ì´ì–¸íŠ¸ í…ŒìŠ¤íŠ¸            |
| **CORS í—¤ë” ì •í™•ì„±**   | Response Headerì— ì˜¬ë°”ë¥¸ Origin ë°˜í™˜ | DevTools Network íƒ­ í™•ì¸          |
| **credentials ì§€ì›**   | ì¿ í‚¤/ì„¸ì…˜ í† í° í¬í•¨ ìš”ì²­ ì„±ê³µ        | ë¡œê·¸ì¸ í›„ ì„¸ì…˜ ìœ ì§€ í™•ì¸          |
| **ì—ëŸ¬ í•¸ë“¤ë§**        | ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ì¶œì²˜ëŠ” 403 ë°˜í™˜       | í—ˆë½ë˜ì§€ ì•Šì€ IPì—ì„œ ìš”ì²­ ì‹œ í™•ì¸ |

### 2.3 ì™„ë£Œ ì •ì˜ (DoD - Definition of Done)

- [ ] CORS ë¯¸ë“¤ì›¨ì–´ ìë™ ìƒì„±ë¨
- [ ] ëª¨ë“  í—ˆìš© originì´ `apps/api/src/middleware/cors.js`ì— ë“±ë¡ë¨
- [ ] Docker Composeì— í™˜ê²½ë³€ìˆ˜ ì„¤ì •ë¨
- [ ] 4ê°€ì§€ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì—ì„œ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ ì™„ë£Œ
- [ ] ì½˜ì†” ë¡œê·¸ì— CORS ê²€ì¦ ë©”ì‹œì§€ ì¶œë ¥ í™•ì¸ë¨
- [ ] ê°œë°œì ë„êµ¬ì—ì„œ Response Headers í™•ì¸ë¨

---

## 3. ë²”ìœ„ (Scope)

### 3.1 í¬í•¨ ë²”ìœ„ (In Scope)

âœ… **ë°±ì—”ë“œ API ì„¤ì •**

- `apps/api/src/middleware/cors.js` íŒŒì¼ ìƒì„±/ìˆ˜ì •
- Express.js CORS ë¯¸ë“¤ì›¨ì–´ ì„¤ì •
- ë™ì  Origin ê²€ì¦ ë¡œì§

âœ… **í™˜ê²½ ì„¤ì •**

- `.env` íŒŒì¼ì— ALLOWED_ORIGINS ì¶”ê°€
- `docker-compose.yml`ì— í™˜ê²½ë³€ìˆ˜ ë§¤í•‘
- í”„ë¡œë•ì…˜ ë°°í¬ ì„¤ì •

âœ… **ë„¤íŠ¸ì›Œí¬ í™˜ê²½ ì§€ì›**

- ìœ ì„  LAN (172.30.1.0/24)
- Tailscale VPN (100.x.x.x)
- ë¬´ì„  WiFi (175.193.199.x, 221.147.112.x ë“±)

âœ… **ë¡œê¹… ë° ë””ë²„ê¹…**

- CORS ìš”ì²­ ë¡œê·¸ ì¶œë ¥
- Origin ë§¤ì¹­ ê²°ê³¼ í‘œì‹œ
- ì°¨ë‹¨ëœ ìš”ì²­ ì—ëŸ¬ ë©”ì‹œì§€

### 3.2 ì œì™¸ ë²”ìœ„ (Out of Scope)

âŒ ì‚¬ë‚´ ë°©í™”ë²½ ê·œì¹™ ë³€ê²½  
âŒ ë„¤íŠ¸ì›Œí¬ ì¸í”„ë¼ ì¬ì„¤ê³„  
âŒ ê¸°ì¡´ API ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •  
âŒ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜  
âŒ í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ ìˆ˜ì •

---

## 4. ê¸°ìˆ  ìš”êµ¬ì‚¬í•­ (Technical Requirements)

### 4.1 í”„ë¡œì íŠ¸ êµ¬ì¡° ë¶„ì„

```
mockup-ai/                           # ëª¨ë…¸ë ˆí¬ ë£¨íŠ¸
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ api/                         # âš™ï¸ Fastify ë°±ì—”ë“œ (ìˆ˜ì • ëŒ€ìƒ)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts        # ğŸ”§ CORS ì„¤ì • ìˆ˜ì • í•„ìš”
â”‚   â”‚   â”‚   â”œâ”€â”€ plugins/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth.plugin.ts  # JWT ì¸ì¦ í”ŒëŸ¬ê·¸ì¸
â”‚   â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth.routes.ts  # ê¸°ì¡´ ì¸ì¦ ë¼ìš°íŠ¸
â”‚   â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth.service.ts # ì¸ì¦ ì„œë¹„ìŠ¤
â”‚   â”‚   â”‚   â”œâ”€â”€ server.ts           # ğŸ”§ CORS í”ŒëŸ¬ê·¸ì¸ ì„¤ì •
â”‚   â”‚   â”‚   â””â”€â”€ worker.ts           # BullMQ ì›Œì»¤
â”‚   â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â”‚   â””â”€â”€ schema.prisma       # DB ìŠ¤í‚¤ë§ˆ
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”œâ”€â”€ web/                         # Next.js í”„ë¡ íŠ¸ì—”ë“œ
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â””â”€â”€ app/
â”‚   â”‚   â”‚       â””â”€â”€ (auth)/
â”‚   â”‚   â”‚           â””â”€â”€ login/
â”‚   â”‚   â”‚               â””â”€â”€ page.tsx # ë¡œê·¸ì¸ í˜ì´ì§€ (App Router)
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ packages/
â”‚   â””â”€â”€ shared/                      # ê³µìœ  íŒ¨í‚¤ì§€
â”œâ”€â”€ docker-compose.yml               # ğŸ”§ CORS_ORIGIN í™˜ê²½ë³€ìˆ˜ ìˆ˜ì • í•„ìš”
â”œâ”€â”€ pnpm-workspace.yaml
â”œâ”€â”€ turbo.json                       # Turborepo ì„¤ì •
â””â”€â”€ package.json
```

### 4.2 í™˜ê²½ ì •ë³´

| í•­ëª©                  | ê°’                          | ì„¤ëª…                              |
| --------------------- | --------------------------- | --------------------------------- |
| **íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €**     | pnpm                        | workspace ì§€ì›                    |
| **ëª¨ë…¸ë ˆí¬**          | pnpm-workspace + Turborepo  | apps/, packages/ íŒ¨í„´             |
| **ë°±ì—”ë“œ í”„ë ˆì„ì›Œí¬** | **Fastify 5.1**             | TypeScript, @fastify/cors ì‚¬ìš©    |
| **ORM**               | Prisma 6.2                  | PostgreSQL 16 ê´€ë¦¬                |
| **í”„ë¡ íŠ¸ì—”ë“œ**        | **Next.js 16.1** (React 19) | App Router, Turbopack             |
| **ìƒíƒœ ê´€ë¦¬**         | Zustand 5, TanStack Query 5 | í´ë¼ì´ì–¸íŠ¸/ì„œë²„ ìƒíƒœ              |
| **ì‘ì—… í**           | BullMQ + Redis 7            | ì´ë¯¸ì§€ ìƒì„± ë¹„ë™ê¸° ì²˜ë¦¬           |
| **AI**                | Gemini API (@google/genai)  | ì´ë¯¸ì§€ ìƒì„±                       |
| **ì»¨í…Œì´ë„ˆ**          | Docker Compose              | postgres, redis, api, worker, web |

### 4.3 CORS í—ˆìš© Origin ëª©ë¡

#### ê°œë°œ í™˜ê²½

- `http://localhost:3000`
- `http://127.0.0.1:3000`
- `http://dev-server.local:3000`

#### ìœ ì„  LAN (ê°™ì€ ì¸µ)

- `http://172.30.1.42:3000` (ì„œë²„ ë§¥ - ë¡œì»¬)
- `http://172.30.1.40:3000` (í´ë¼ì´ì–¸íŠ¸ ë§¥)

#### Tailscale VPN (ëª¨ë“  ì¸µ/ê±´ë¬¼)

- `http://100.69.75.47:3000` (í˜„ì¬ ì„œë²„)
- `http://[tailscale-ip]:3000` (ê¸°íƒ€ í´ë¼ì´ì–¸íŠ¸)

#### ë¬´ì„  WiFi (ê° ì¸µ/ê±´ë¬¼ë³„ ë‹¤ë¦„)

- `http://175.193.199.147:3000` (ì„œë²„ ë¬´ì„ )
- `http://221.147.112.147:3000` (í´ë¼ì´ì–¸íŠ¸ ë¬´ì„ )
- `http://[other-floor-ip]:3000` (ì¶”í›„ ì¶”ê°€)

### 4.4 CORS ì •ì±… ìƒì„¸

```
Method: Dynamic Origin Matching
Approach: ìš”ì²­ì˜ Origin í—¤ë”ë¥¼ ì‹ ë¢° ëª©ë¡ê³¼ ë¹„êµ

Headers to Set:
â”œâ”€ Access-Control-Allow-Origin: <matched-origin>
â”œâ”€ Access-Control-Allow-Methods: GET, POST, PUT, DELETE, PATCH, OPTIONS
â”œâ”€ Access-Control-Allow-Headers: Content-Type, Authorization
â”œâ”€ Access-Control-Allow-Credentials: true
â”œâ”€ Access-Control-Max-Age: 3600
â””â”€ Access-Control-Expose-Headers: Content-Range, X-Content-Range

Preflight Handling: OPTIONS ìš”ì²­ ìë™ ì²˜ë¦¬
```

---

## 5. êµ¬í˜„ ë°©ë²• (Implementation Strategy)

### 5.1 Phase 1: config/index.ts CORS ì„¤ì • ìˆ˜ì •

**íŒŒì¼**: `apps/api/src/config/index.ts` (ê¸°ì¡´ íŒŒì¼ ìˆ˜ì •)

```typescript
import { z } from 'zod';
import dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';

// ê°œë°œ í™˜ê²½ì—ì„œ .env íŒŒì¼ ë¡œë“œ (productionì€ docker-composeì—ì„œ ì£¼ì…)
if (process.env.NODE_ENV !== 'production') {
  const __dirname = path.dirname(fileURLToPath(import.meta.url));
  dotenv.config({ path: path.resolve(__dirname, '../../../../.env') });
}

/**
 * âœ… ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ëª¨ë“  ì¶œì²˜ ëª©ë¡
 * ì‚¬ë‚´ ë„¤íŠ¸ì›Œí¬ì˜ ëª¨ë“  í™˜ê²½(ìœ ì„ /ë¬´ì„ /Tailscale)ì—ì„œ ì ‘ê·¼ í—ˆìš©
 */
const ALLOWED_ORIGINS = [
  // ê°œë°œ í™˜ê²½
  'http://localhost:3000',
  'http://127.0.0.1:3000',

  // ìœ ì„  LAN (172.30.1.0/24)
  'http://172.30.1.42:3000', // ì„œë²„ ë§¥ - ë¡œì»¬
  'http://172.30.1.40:3000', // í´ë¼ì´ì–¸íŠ¸ ë§¥

  // Tailscale VPN (100.x.x.x)
  'http://100.69.75.47:3000', // í˜„ì¬ ì„œë²„ Tailscale IP

  // ë¬´ì„  WiFi
  'http://175.193.199.147:3000', // ì„œë²„ ë¬´ì„  IP
  'http://221.147.112.147:3000', // í´ë¼ì´ì–¸íŠ¸ ë¬´ì„  IP
];

/**
 * í™˜ê²½ ë³€ìˆ˜ ìŠ¤í‚¤ë§ˆ ì •ì˜
 */
const envSchema = z.object({
  // ì„œë²„ ì„¤ì •
  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
  API_PORT: z.coerce.number().default(4000),

  // ë°ì´í„°ë² ì´ìŠ¤
  DATABASE_URL: z.string().url(),

  // Redis
  REDIS_URL: z.string().url(),

  // JWT
  JWT_SECRET: z.string().min(32),
  JWT_ACCESS_EXPIRY: z.string().default('15m'),
  JWT_REFRESH_EXPIRY: z.string().default('7d'),

  // Gemini API
  GEMINI_API_KEY: z.string().optional(),

  // íŒŒì¼ ì—…ë¡œë“œ
  MAX_FILE_SIZE: z.coerce.number().default(10 * 1024 * 1024), // 10MB
  UPLOAD_DIR: z.string().default('./data'),

  // CORS (ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì—¬ëŸ¬ origin ì§€ì›)
  CORS_ORIGIN: z.string().default('http://localhost:3000'),
});

/**
 * CORS Origin íŒŒì‹±
 * í™˜ê²½ë³€ìˆ˜ì˜ ì‰¼í‘œë¡œ êµ¬ë¶„ëœ origin ëª©ë¡ + í•˜ë“œì½”ë”©ëœ ëª©ë¡ ë³‘í•©
 */
function parseCorsOrigins(envOrigin: string): string[] {
  const envOrigins = envOrigin
    .split(',')
    .map((o) => o.trim())
    .filter(Boolean);
  // í™˜ê²½ë³€ìˆ˜ì™€ í•˜ë“œì½”ë”©ëœ ëª©ë¡ ë³‘í•© (ì¤‘ë³µ ì œê±°)
  return [...new Set([...ALLOWED_ORIGINS, ...envOrigins])];
}

/**
 * í™˜ê²½ ë³€ìˆ˜ íŒŒì‹± ë° ê²€ì¦
 */
function parseEnv() {
  const parsed = envSchema.safeParse(process.env);

  if (!parsed.success) {
    console.error('âŒ í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ ì‹¤íŒ¨:');
    console.error(parsed.error.format());

    // ê°œë°œ í™˜ê²½ì—ì„œëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©
    if (process.env.NODE_ENV === 'development') {
      console.warn('âš ï¸ ê°œë°œ í™˜ê²½ì—ì„œ ê¸°ë³¸ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤');
      return {
        nodeEnv: 'development' as const,
        port: 4000,
        databaseUrl: 'postgresql://user:password@localhost:5432/mockup?schema=public',
        redisUrl: 'redis://localhost:6379',
        jwtSecret: 'development-secret-key-change-in-production',
        jwtAccessExpiry: '15m',
        jwtRefreshExpiry: '7d',
        geminiApiKey: undefined,
        maxFileSize: 10 * 1024 * 1024,
        uploadDir: './data',
        corsOrigins: ALLOWED_ORIGINS,
      };
    }

    throw new Error('í™˜ê²½ ë³€ìˆ˜ ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
  }

  return {
    nodeEnv: parsed.data.NODE_ENV,
    port: parsed.data.API_PORT,
    databaseUrl: parsed.data.DATABASE_URL,
    redisUrl: parsed.data.REDIS_URL,
    jwtSecret: parsed.data.JWT_SECRET,
    jwtAccessExpiry: parsed.data.JWT_ACCESS_EXPIRY,
    jwtRefreshExpiry: parsed.data.JWT_REFRESH_EXPIRY,
    geminiApiKey: parsed.data.GEMINI_API_KEY,
    maxFileSize: parsed.data.MAX_FILE_SIZE,
    uploadDir: parsed.data.UPLOAD_DIR,
    corsOrigins: parseCorsOrigins(parsed.data.CORS_ORIGIN),
  };
}

export const config = parseEnv();

export type Config = typeof config;
```

**ì„¤ëª…**:

- `ALLOWED_ORIGINS` ë°°ì—´ì— ëª¨ë“  ì‚¬ë‚´ ë„¤íŠ¸ì›Œí¬ IP í•˜ë“œì½”ë”©
- í™˜ê²½ë³€ìˆ˜ `CORS_ORIGIN`ì—ì„œ ì¶”ê°€ originì„ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ë™ì  ì¶”ê°€ ê°€ëŠ¥
- `parseCorsOrigins` í•¨ìˆ˜ë¡œ í•˜ë“œì½”ë”© ëª©ë¡ê³¼ í™˜ê²½ë³€ìˆ˜ ë³‘í•©
- ê¸°ì¡´ `corsOrigin` (ë‹¨ì¼) â†’ `corsOrigins` (ë°°ì—´)ë¡œ ë³€ê²½

### 5.2 Phase 2: ë°±ì—”ë“œ ì„œë²„ íŒŒì¼ ìˆ˜ì •

**íŒŒì¼**: `apps/api/src/server.ts`

**ìˆ˜ì • ì „**:

```typescript
import cors from '@fastify/cors';
import { config } from './config/index.js';

// ...

async function registerPlugins() {
  // âŒ ê¸°ì¡´: ë‹¨ì¼ originë§Œ í—ˆìš©
  await server.register(cors, {
    origin: config.corsOrigin,
    credentials: true,
  });
  // ...
}
```

**ìˆ˜ì • í›„**:

```typescript
import Fastify from 'fastify';
import cors from '@fastify/cors';
import multipart from '@fastify/multipart';
import { config } from './config/index.js';
import authPlugin from './plugins/auth.plugin.js';
import authRoutes from './routes/auth.routes.js';
import projectRoutes from './routes/project.routes.js';
import uploadRoutes from './routes/upload.routes.js';
import characterRoutes from './routes/character.routes.js';
import generationRoutes from './routes/generation.routes.js';
import imageRoutes from './routes/image.routes.js';
import editRoutes from './routes/edit.routes.js';

/**
 * Fastify ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
 */
const server = Fastify({
  logger: {
    level: config.nodeEnv === 'development' ? 'debug' : 'info',
    transport:
      config.nodeEnv === 'development'
        ? {
            target: 'pino-pretty',
            options: {
              colorize: true,
              translateTime: 'HH:MM:ss Z',
              ignore: 'pid,hostname',
            },
          }
        : undefined,
  },
});

/**
 * í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
 */
async function registerPlugins() {
  // âœ… CORS ì„¤ì • (ë‹¤ì¤‘ Origin ì§€ì›)
  await server.register(cors, {
    origin: (origin, cb) => {
      // ë¡œê¹…: ì–´ëŠ IPì—ì„œ ìš”ì²­ ë“¤ì–´ì™”ëŠ”ì§€ ê¸°ë¡
      server.log.info(`[CORS] Incoming request from origin: ${origin}`);

      // Case 1: origin ì—†ëŠ” ìš”ì²­ (ê°™ì€ ì¶œì²˜, ëª¨ë°”ì¼ ì•±, curl ë“±)
      if (!origin) {
        server.log.info('[CORS] âœ… No origin header (same-site or non-browser)');
        return cb(null, true);
      }

      // Case 2: ì‹ ë¢° ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
      if (config.corsOrigins.includes(origin)) {
        server.log.info(`[CORS] âœ… ALLOWED: ${origin}`);
        return cb(null, true);
      }

      // Case 3: ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ì¶œì²˜
      server.log.warn(`[CORS] âŒ BLOCKED: ${origin} (not in allowed list)`);
      server.log.warn(`[CORS] Allowed origins: ${config.corsOrigins.join(', ')}`);
      return cb(new Error('CORS policy violation: Origin not allowed'), false);
    },
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization'],
    exposedHeaders: ['Content-Range', 'X-Content-Range'],
    maxAge: 3600,
  });

  // Multipart íŒŒì¼ ì—…ë¡œë“œ
  await server.register(multipart, {
    limits: {
      fileSize: config.maxFileSize,
    },
  });

  // JWT ì¸ì¦ í”ŒëŸ¬ê·¸ì¸
  await server.register(authPlugin);
}

// ... ë‚˜ë¨¸ì§€ ì½”ë“œ ë™ì¼ ...
```

**@fastify/cors origin ì½œë°± ì„¤ëª…**:

- `origin` íŒŒë¼ë¯¸í„°: ìš”ì²­ì˜ Origin í—¤ë” ê°’ (ì—†ìœ¼ë©´ undefined)
- `cb(null, true)`: í•´ë‹¹ origin í—ˆìš©
- `cb(error, false)`: í•´ë‹¹ origin ì°¨ë‹¨
- `config.corsOrigins`: config/index.tsì—ì„œ íŒŒì‹±ëœ í—ˆìš© origin ë°°ì—´

### 5.3 Phase 3: í™˜ê²½ì„¤ì • íŒŒì¼ ìˆ˜ì •

**íŒŒì¼**: `.env` (í”„ë¡œì íŠ¸ ë£¨íŠ¸)

```env
# ì„œë²„ ì„¤ì •
NODE_ENV=development
API_PORT=4000

# ë°ì´í„°ë² ì´ìŠ¤
DATABASE_URL=postgresql://user:password@localhost:5432/mockup?schema=public

# Redis
REDIS_URL=redis://localhost:6379

# JWT (ìµœì†Œ 32ì ì´ìƒ)
JWT_SECRET=your-super-secret-jwt-key-at-least-32-chars

# Gemini API
GEMINI_API_KEY=your-gemini-api-key

# ğŸ†• CORS ì„¤ì • (ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì¶”ê°€ origin - í•˜ë“œì½”ë”©ëœ ëª©ë¡ì— ë³‘í•©ë¨)
# config/index.tsì˜ ALLOWED_ORIGINS ë°°ì—´ê³¼ í•©ì³ì ¸ì„œ ì‚¬ìš©ë¨
CORS_ORIGIN=http://localhost:3000,http://172.30.1.42:3000,http://100.69.75.47:3000

# í”„ë¡ íŠ¸ì—”ë“œ API URL
NEXT_PUBLIC_API_URL=http://localhost:4000
```

**ì°¸ê³ **: ê°œë°œ í™˜ê²½ì—ì„œëŠ” ë£¨íŠ¸ `.env` íŒŒì¼ì„, Docker í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” `docker-compose.yml`ì˜ environment ì„¹ì…˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

### 5.4 Phase 4: Docker Compose ìˆ˜ì •

**íŒŒì¼**: `docker-compose.yml`

**ìˆ˜ì • ì „**:

```yaml
services:
  api:
    # ...
    environment:
      # âŒ ê¸°ì¡´: ë‹¨ì¼ originë§Œ í—ˆìš©
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000}
```

**ìˆ˜ì • í›„**:

```yaml
services:
  # PostgreSQL ë°ì´í„°ë² ì´ìŠ¤
  postgres:
    image: postgres:16-alpine
    container_name: mockup-postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: mockup
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U user -d mockup']
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis ìºì‹œ ë° ì‘ì—… í
  redis:
    image: redis:7-alpine
    container_name: mockup-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - '6379:6379'
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # DB ë§ˆì´ê·¸ë ˆì´ì…˜ (í•œ ë²ˆë§Œ ì‹¤í–‰)
  migrate:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
      target: migrate
    container_name: mockup-migrate
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/mockup?schema=public
    depends_on:
      postgres:
        condition: service_healthy
    restart: 'no'

  # Fastify API ì„œë²„
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    container_name: mockup-api
    ports:
      - '4000:4000'
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://user:password@postgres:5432/mockup?schema=public
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET:-super-secret-jwt-key-change-in-production}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - UPLOAD_DIR=/app/data
      # âœ… CORS í—ˆìš© origin (ì‰¼í‘œë¡œ êµ¬ë¶„, config/index.tsì˜ ALLOWED_ORIGINSì™€ ë³‘í•©ë¨)
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000,http://172.30.1.42:3000,http://100.69.75.47:3000,http://175.193.199.147:3000,http://221.147.112.147:3000}
    volumes:
      - app_data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:4000/health']
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ì‘ì—… ì²˜ë¦¬ ì›Œì»¤ (ì´ë¯¸ì§€ ìƒì„± ë“±)
  worker:
    build:
      context: .
      dockerfile: apps/api/Dockerfile.worker
    container_name: mockup-worker
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://user:password@postgres:5432/mockup?schema=public
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET:-super-secret-jwt-key-change-in-production}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - UPLOAD_DIR=/app/data
    volumes:
      - app_data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    restart: unless-stopped

  # Next.js í”„ë¡ íŠ¸ì—”ë“œ
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        # âœ… ì„œë²„ ë°°í¬ ì‹œ ì‹¤ì œ ì„œë²„ IPë¡œ ë³€ê²½ í•„ìš”
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://172.30.1.42:4000}
    container_name: mockup-web
    ports:
      - '3000:3000'
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  app_data:
```

**ì£¼ìš” ë³€ê²½ì‚¬í•­**:

- `CORS_ORIGIN` í™˜ê²½ë³€ìˆ˜ì— ëª¨ë“  ë„¤íŠ¸ì›Œí¬ IP ì¶”ê°€ (ì‰¼í‘œ êµ¬ë¶„)
- `NEXT_PUBLIC_API_URL`ë¡œ í”„ë¡ íŠ¸ì—”ë“œ API URL ì„¤ì • (Next.js í˜•ì‹)
- PostgreSQL 16, Redis 7 ì‚¬ìš©
- worker ì„œë¹„ìŠ¤ë¡œ ë¹„ë™ê¸° ì´ë¯¸ì§€ ìƒì„± ì²˜ë¦¬

---

## 6. ì‹¤í–‰ ìˆœì„œ (Execution Plan)

### 6.1 ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸

```bash
# Step 1: í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd mockup-ai

# Step 2: apps/api/src/config/index.ts ìˆ˜ì •
# - ALLOWED_ORIGINS ë°°ì—´ì— ëª¨ë“  ë„¤íŠ¸ì›Œí¬ IP ì¶”ê°€
# - corsOrigin â†’ corsOrigins (ë°°ì—´)ë¡œ ë³€ê²½

# Step 3: apps/api/src/server.ts ìˆ˜ì •
# - @fastify/cors origin ì½œë°± í•¨ìˆ˜ë¡œ ë³€ê²½
# - config.corsOrigins ë°°ì—´ ì‚¬ìš©

# Step 4: ë£¨íŠ¸ .env íŒŒì¼ í™•ì¸/ìƒì„±
cat .env
# í•„ìš” ì‹œ CORS_ORIGIN í™˜ê²½ë³€ìˆ˜ ì¶”ê°€

# Step 5: ë¡œì»¬ ê°œë°œ ì„œë²„ ì‹¤í–‰ (Turborepo)
pnpm dev

# Step 6: API ì„œë²„ ë¡œê·¸ í™•ì¸
# [CORS] âœ… ALLOWED: http://xxx.xxx.xxx.xxx:3000 ë©”ì‹œì§€ í™•ì¸
```

### 6.2 Docker í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸

```bash
# Step 1: ì´ë¯¸ì§€ ë¹Œë“œ (ë³€ê²½ì‚¬í•­ í¬í•¨)
docker-compose build

# Step 2: ì»¨í…Œì´ë„ˆ ì‹œì‘
docker-compose up -d

# Step 3: ë¡œê·¸ í™•ì¸
docker-compose logs -f api

# Step 4: ê° ë„¤íŠ¸ì›Œí¬ì—ì„œ í…ŒìŠ¤íŠ¸ (ì•„ë˜ 6.3 ì°¸ì¡°)
```

### 6.3 ë„¤íŠ¸ì›Œí¬ë³„ ì ‘ê·¼ í…ŒìŠ¤íŠ¸

#### Test 1: ìœ ì„  LAN (ê°™ì€ ì¸µ)

```bash
# 172.30.1.40 (ë˜ëŠ” 172.30.1.42)ì—ì„œ ì‹¤í–‰
curl -X OPTIONS \
  -H "Origin: http://172.30.1.40:3000" \
  -H "Access-Control-Request-Method: POST" \
  http://172.30.1.42:4000/api/auth/login \
  -v

# ì˜ˆìƒ ê²°ê³¼:
# < HTTP/1.1 200 OK
# < Access-Control-Allow-Origin: http://172.30.1.40:3000
# < Access-Control-Allow-Methods: GET, POST, PUT, DELETE, PATCH, OPTIONS
```

#### Test 2: Tailscale VPN

```bash
# Tailscale í´ë¼ì´ì–¸íŠ¸ê°€ ì„¤ì¹˜ëœ ë””ë°”ì´ìŠ¤ì—ì„œ ì‹¤í–‰
curl -X OPTIONS \
  -H "Origin: http://100.69.75.47:3000" \
  -H "Access-Control-Request-Method: POST" \
  http://172.30.1.42:4000/api/auth/login \
  -v

# ì˜ˆìƒ ê²°ê³¼:
# < HTTP/1.1 200 OK
# < Access-Control-Allow-Origin: http://100.69.75.47:3000
```

#### Test 3: ë¬´ì„  WiFi (ë‹¤ë¥¸ ì¸µ/ê±´ë¬¼)

```bash
# 221.147.112.147 ë˜ëŠ” 175.193.199.147ì—ì„œ ì‹¤í–‰
curl -X OPTIONS \
  -H "Origin: http://221.147.112.147:3000" \
  -H "Access-Control-Request-Method: POST" \
  http://172.30.1.42:4000/api/auth/login \
  -v

# ì˜ˆìƒ ê²°ê³¼:
# < HTTP/1.1 200 OK
# < Access-Control-Allow-Origin: http://221.147.112.147:3000
```

#### Test 4: ë¸Œë¼ìš°ì € ë¡œê·¸ì¸ (ì‹¤ì œ í…ŒìŠ¤íŠ¸)

```
1. http://172.30.1.42:3000 ì—ì„œ ë¡œê·¸ì¸ ì‹œë„
   â†’ âœ… ì„±ê³µ (ìœ ì„  LAN)

2. Tailscale IPë¡œ ì ‘ê·¼ í›„ ë¡œê·¸ì¸ ì‹œë„
   â†’ âœ… ì„±ê³µ (VPN)

3. ë‹¤ë¥¸ ì¸µ WiFiì—ì„œ ë¡œê·¸ì¸ ì‹œë„
   â†’ âœ… ì„±ê³µ (ë¬´ì„ )

4. ê°œë°œì ë„êµ¬ (F12) â†’ Network â†’ login ìš”ì²­ í™•ì¸
   â†’ Response Headersì— Access-Control-Allow-Origin í™•ì¸
```

---

## 7. ê²€ì¦ ë°©ë²• (Validation)

### 7.1 ìë™ ê²€ì¦ (ìë™í™”ëœ í…ŒìŠ¤íŠ¸)

```bash
# ìœ íš¨í•œ origin í…ŒìŠ¤íŠ¸
for origin in "http://172.30.1.40:3000" "http://100.69.75.47:3000" "http://221.147.112.147:3000"; do
  echo "Testing: $origin"
  curl -s -X OPTIONS \
    -H "Origin: $origin" \
    -H "Access-Control-Request-Method: POST" \
    http://172.30.1.42:4000/api/auth/login \
    | grep "Access-Control-Allow-Origin"
done

# ìœ íš¨í•˜ì§€ ì•Šì€ origin í…ŒìŠ¤íŠ¸
echo "Testing invalid origin: http://evil.com:3000"
curl -s -X OPTIONS \
  -H "Origin: http://evil.com:3000" \
  -H "Access-Control-Request-Method: POST" \
  http://172.30.1.42:4000/api/auth/login \
  -w "\nHTTP Status: %{http_code}\n"
```

### 7.2 ìˆ˜ë™ ê²€ì¦ (ê°œë°œì)

| í…ŒìŠ¤íŠ¸ í•­ëª©          | ê¸°ëŒ€ ê²°ê³¼                                | í™•ì¸ ë°©ë²•                             |
| -------------------- | ---------------------------------------- | ------------------------------------- |
| **CORS í—¤ë” ì¡´ì¬**   | `Access-Control-Allow-Origin` í—¤ë” í¬í•¨  | DevTools â†’ Network â†’ Response Headers |
| **Origin ë§¤ì¹­**      | ìš”ì²­ originê³¼ ì‘ë‹µ headerì˜ ê°’ì´ ë™ì¼    | curl -v ë˜ëŠ” DevTools í™•ì¸            |
| **credentials ì§€ì›** | `Access-Control-Allow-Credentials: true` | Response Headersì— í‘œì‹œ               |
| **OPTIONS ì²˜ë¦¬**     | Preflight ìš”ì²­ì´ 200 ì‘ë‹µ                | Network íƒ­ì—ì„œ OPTIONS ìš”ì²­ í™•ì¸      |
| **ë¡œê·¸ ì¶œë ¥**        | `[CORS] âœ… ALLOWED:` ë©”ì‹œì§€ ì¶œë ¥         | docker-compose logs api               |
| **ì°¨ë‹¨ëœ origin**    | í—ˆë½ë˜ì§€ ì•Šì€ IPëŠ” 403 ë˜ëŠ” CORS ì—ëŸ¬    | curl ë˜ëŠ” DevToolsì—ì„œ í™•ì¸           |

---

## 8. ë¡¤ë°± ê³„íš (Rollback Plan)

ë¬¸ì œ ë°œìƒ ì‹œ ì´ì „ ìƒíƒœë¡œ ë³µêµ¬:

### 8.1 ë¬¸ì œ ì¦ìƒ

- CORS ì—ëŸ¬ ì—¬ì „íˆ ë°œìƒ
- íŠ¹ì • ë„¤íŠ¸ì›Œí¬ë§Œ ì ‘ê·¼ ë¶ˆê°€
- 500 Internal Server Error

### 8.2 ë¡¤ë°± ì ˆì°¨

```bash
# Step 1: ë³€ê²½ì‚¬í•­ ë˜ëŒë¦¬ê¸°
git checkout -- apps/api/src/index.js
git checkout -- docker-compose.yml

# Step 2: CORS ë¯¸ë“¤ì›¨ì–´ íŒŒì¼ ì‚­ì œ
rm apps/api/src/middleware/cors.js

# Step 3: Docker ì¬ì‹œì‘
docker-compose down
docker-compose up -d

# Step 4: ë¡œê·¸ í™•ì¸
docker-compose logs -f api
```

### 8.3 ë””ë²„ê¹… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] `apps/api/src/config/index.ts`ì˜ `ALLOWED_ORIGINS` ë°°ì—´ì— ëª¨ë“  ë„¤íŠ¸ì›Œí¬ IPê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ê°€?
- [ ] `apps/api/src/server.ts`ì—ì„œ `@fastify/cors`ì˜ `origin` ì˜µì…˜ì´ ì½œë°± í•¨ìˆ˜ë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ”ê°€?
- [ ] `config.corsOrigins` (ë°°ì—´)ì„ ì‚¬ìš©í•˜ê³  ìˆëŠ”ê°€? (ê¸°ì¡´ `corsOrigin` ë‹¨ì¼ ê°’ ì•„ë‹˜)
- [ ] docker-composeì˜ `CORS_ORIGIN` í™˜ê²½ë³€ìˆ˜ì— ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ëª¨ë“  originì´ ìˆëŠ”ê°€?
- [ ] ë„¤íŠ¸ì›Œí¬ ë°©í™”ë²½ì´ í¬íŠ¸ 3000(web), 4000(api)ì„ ì—´ì–´ë‘ì—ˆëŠ”ê°€?
- [ ] TypeScript ì»´íŒŒì¼ ì—ëŸ¬ê°€ ì—†ëŠ”ê°€? (`pnpm type-check`)

---

## 9. ì¶”ê°€ ê³ ë ¤ì‚¬í•­ (Additional Considerations)

### 9.1 ë³´ì•ˆ

âš ï¸ **ì£¼ì˜**: í˜„ì¬ ì„¤ì •ì€ íšŒì‚¬ ë‚´ë¶€ë§ìš©ì…ë‹ˆë‹¤. ì™¸ë¶€ ì¸í„°ë„· ë…¸ì¶œ ì‹œ ìœ„í—˜:

- Tailscale IPë¥¼ `allowedOrigins`ì— í¬í•¨ (ì œí•œëœ VPNì´ë¯€ë¡œ ì•ˆì „)
- ì™€ì¼ë“œì¹´ë“œ `*` ì‚¬ìš© ê¸ˆì§€
- í”„ë¡œë•ì…˜ì—ì„œëŠ” ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” IPë§Œ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€

### 9.2 í™•ì¥ì„±

í–¥í›„ ë‹¤ë¥¸ ê±´ë¬¼/ì¸µì´ ì¶”ê°€ë˜ë©´:

```javascript
const allowedOrigins = [
  // ê¸°ì¡´
  'http://172.30.1.42:3000',

  // ğŸ†• 2ì¸µ
  'http://172.30.2.x:3000',

  // ğŸ†• 3ì¸µ
  'http://172.30.3.x:3000',

  // ğŸ†• B ê±´ë¬¼
  'http://172.31.1.x:3000',
];
```

ë˜ëŠ” ì •ê·œí‘œí˜„ì‹ ê¸°ë°˜ ë§¤ì¹­:

```javascript
origin: (origin, callback) => {
  // 172.30.x.x ëŒ€ì—­ ëª¨ë‘ í—ˆìš©
  if (!origin || /^http:\/\/172\.30\.\d+\.\d+:3000$/.test(origin)) {
    callback(null, true);
  } else {
    callback(new Error('CORS blocked'));
  }
};
```

### 9.3 ëª¨ë‹ˆí„°ë§

í”„ë¡œë•ì…˜ ë°°í¬ í›„ CORS ê´€ë ¨ ë©”íŠ¸ë¦­ ëª¨ë‹ˆí„°ë§:

```javascript
app.use((req, res, next) => {
  const origin = req.headers.origin;
  if (origin) {
    console.log(`[METRICS] CORS request from: ${origin}`);
    // Datadog, New Relic ë“±ì— ì „ì†¡
  }
  next();
});
```

---

## 10. ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸ (Completion Checklist)

### Phase 1: ê°œë°œ

- [ ] `apps/api/src/middleware/cors.js` ìƒì„±
- [ ] `apps/api/src/index.js` ìˆ˜ì • (CORS ë¯¸ë“¤ì›¨ì–´ ì¶”ê°€)
- [ ] `apps/api/.env` í™•ì¸ ë° í•„ìš” ì‹œ ì—…ë°ì´íŠ¸
- [ ] ë¡œì»¬ `pnpm dev`ë¡œ í…ŒìŠ¤íŠ¸

### Phase 2: Docker ë°°í¬

- [ ] `docker-compose.yml` ìˆ˜ì •
- [ ] `docker-compose build` ì‹¤í–‰
- [ ] `docker-compose up -d` ì‹¤í–‰
- [ ] `docker-compose logs -f api` ë¡œê·¸ í™•ì¸

### Phase 3: ë„¤íŠ¸ì›Œí¬ í…ŒìŠ¤íŠ¸

- [ ] ìœ ì„  LANì—ì„œ ë¡œê·¸ì¸ ì„±ê³µ
- [ ] Tailscale VPNì—ì„œ ë¡œê·¸ì¸ ì„±ê³µ
- [ ] ë¬´ì„  WiFi (221.147.112.147)ì—ì„œ ë¡œê·¸ì¸ ì„±ê³µ
- [ ] ë‹¤ë¥¸ ê±´ë¬¼ ë¬´ì„ ì—ì„œ ë¡œê·¸ì¸ ì„±ê³µ (ì¶”í›„ IP ì¶”ê°€)

### Phase 4: ê²€ì¦

- [ ] DevTools â†’ Network â†’ login ìš”ì²­ í™•ì¸
- [ ] Response Headersì— `Access-Control-Allow-Origin` í™•ì¸
- [ ] ì½˜ì†” ë¡œê·¸ì— `[CORS] âœ… ALLOWED:` ë©”ì‹œì§€ í™•ì¸
- [ ] ì¿ í‚¤/ì„¸ì…˜ ë¡œê·¸ì¸ ìœ ì§€ í™•ì¸

### Phase 5: ë¬¸ì„œí™”

- [ ] ì´ PRD ë¬¸ì„œ ì™„ë£Œ
- [ ] TRD (ê¸°ìˆ  ìš”êµ¬ì‚¬í•­) ì—…ë°ì´íŠ¸
- [ ] íŒ€ì›ë“¤ì—ê²Œ ë³€ê²½ì‚¬í•­ ê³µìœ 
- [ ] í–¥í›„ ë„¤íŠ¸ì›Œí¬ ì¶”ê°€ ì‹œ procedures ì •ì˜

---

## 11. ì°¸ê³  ìë£Œ (References)

- [Express CORS Middleware Docs](https://expressjs.com/en/resources/middleware/cors.html)
- [MDN CORS Documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)
- [Tailscale Networking](https://tailscale.com/kb/)
- [Docker Compose Networking](https://docs.docker.com/compose/networking/)

---

**ë¬¸ì„œ ì‘ì„±ì**: AI Agent  
**ìµœì¢… ê²€í† **: í•„ìˆ˜  
**ë°°í¬ ì „ ìŠ¹ì¸**: í•„ìˆ˜
